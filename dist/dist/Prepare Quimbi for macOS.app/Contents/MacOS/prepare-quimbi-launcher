#!/bin/bash

# Launcher script for Quimbi Preparation Tool
# This opens Terminal and runs the preparation tool with a nice interface

# Get the directory where this app bundle is located
APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
SCRIPT_PATH="$APP_DIR/prepare-quimbi-macos"

# Check if the preparation script exists
if [ ! -f "$SCRIPT_PATH" ]; then
    # Try to find it in the same directory as the app bundle
    SCRIPT_PATH="$(dirname "$APP_DIR")/prepare-quimbi-macos"
    
    if [ ! -f "$SCRIPT_PATH" ]; then
        osascript -e 'display alert "Quimbi Preparation Tool" message "Could not find the preparation script. Please ensure prepare-quimbi-macos is in the same folder as this app." as critical'
        exit 1
    fi
fi

# Create a temporary script that will run in Terminal
TEMP_SCRIPT="/tmp/quimbi-prep-$$.sh"
cat > "$TEMP_SCRIPT" << INNER_EOF
#!/bin/bash

# Quimbi Preparation Tool - Terminal Interface
clear
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    ðŸ¤– Quimbi Preparation Tool for macOS                     â•‘"
echo "â•‘                                                                              â•‘"
echo "â•‘  This tool will prepare your Mac to run the Quimbi Support Assistant by:    â•‘"
echo "â•‘                                                                              â•‘"
echo "â•‘  âœ… Installing Ollama AI runtime (if needed)                                â•‘"
echo "â•‘  âœ… Downloading llama3.1:8b model (~4.7GB, if needed)                      â•‘"
echo "â•‘  âœ… Verifying everything works correctly                                    â•‘"
echo "â•‘                                                                              â•‘"
echo "â•‘  Requirements:                                                               â•‘"
echo "â•‘  â€¢ macOS 10.15 or later                                                     â•‘"
echo "â•‘  â€¢ 8GB+ free disk space                                                     â•‘"
echo "â•‘  â€¢ Internet connection                                                       â•‘"
echo "â•‘                                                                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Ask user if they want to proceed
read -p "ðŸš€ Press Enter to begin preparation, or type 'cancel' to exit: " response

if [[ "\$response" == "cancel" ]] || [[ "\$response" == "c" ]]; then
    echo ""
    echo "âŒ Preparation cancelled by user."
    echo ""
    read -p "Press Enter to close this window..."
    exit 0
fi

echo ""
echo "ðŸ”„ Starting Quimbi preparation process..."
echo ""

# Run the actual preparation tool with verbose output for better user experience
"$SCRIPT_PATH" --verbose

# Capture the exit code
PREP_EXIT_CODE=\$?

echo ""
if [ \$PREP_EXIT_CODE -eq 0 ]; then
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                          ðŸŽ‰ SUCCESS! Ready for Quimbi!                      â•‘"
    echo "â•‘                                                                              â•‘"
    echo "â•‘  Your Mac is now prepared to run the Quimbi Support Assistant!             â•‘"
    echo "â•‘                                                                              â•‘"
    echo "â•‘  Next steps:                                                                 â•‘"
    echo "â•‘  1. Close this window                                                        â•‘"
    echo "â•‘  2. Run 'Quimbi Support Assistant.app'                                      â•‘"
    echo "â•‘                                                                              â•‘"
    echo "â•‘  The AI will now work smoothly with llama3.1:8b model ready to go!         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
else
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                          âŒ Preparation Failed                               â•‘"
    echo "â•‘                                                                              â•‘"
    echo "â•‘  Something went wrong during the preparation process.                        â•‘"
    echo "â•‘                                                                              â•‘"
    echo "â•‘  Possible solutions:                                                         â•‘"
    echo "â•‘  â€¢ Check your internet connection                                           â•‘"
    echo "â•‘  â€¢ Ensure you have enough disk space (8GB+)                                â•‘"
    echo "â•‘  â€¢ Try running this tool again                                              â•‘"
    echo "â•‘  â€¢ Contact support if the problem persists                                  â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
fi

echo ""
read -p "Press Enter to close this window..."

# Clean up the temporary script
rm -f "$TEMP_SCRIPT"
INNER_EOF

chmod +x "$TEMP_SCRIPT"

# Open Terminal and run the script
osascript << APPLESCRIPT
tell application "Terminal"
    activate
    do script "bash '$TEMP_SCRIPT'"
end tell
APPLESCRIPT
